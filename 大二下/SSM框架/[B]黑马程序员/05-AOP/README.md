# 05-AOP

## 01-AOP简介
### AOP简介
- AOP(Aspect Oriented Programming)面向切面编程,  一种编程范式,  指导开发者如何组织程序结构
  - OOP(Object Oriented Programming)面向对象编程
- 作用:在不惊动原始设计的基础上为其进行功能增强
- Spring理念:无入侵式/无侵入式

### AOP核心概念
- 连接点(JoinPoint):程序执行过程中的任意位置,  粒度为执行方法、抛出异常、设置变量等
    - 在SpringAOP中,  理解为方法的执行
- 切入点(Pointcut):匹配连接点的式子
    - 在SpringAOP中,  一个切入点可以只描述一个具体方法,  也可以匹配多个方法
        - 一个具体方法:com.itheima.dao包下的BookDao接口中的无形参无返回值的save方法
        - 匹配多个方法:所有的save方法，所有的get开头的方法，所有以Dao结尾的接口中的任意方法，所有带有一个参数的方法
- 通知(Advice):在切入点处执行的操作,  也就是共性功能
    - 在SpringAOP中,  功能最终以方法的形式呈现
- 通知类:定义通知的类
- 切面(Aspect):描述通知与切入点的对应关系
- 目标对象(Target):原始功能去掉共性功能对应的类F生的对象,  这种对象是无法直接完成最终工作的
- 代理(Proxy):目标对象无法直接完成工作,  需要对其进行功能回填,  通过原始对象的代理对象实现

## 03-AOP工作流程
### AOP工作流程
1. Spring容器启动
2. 读取所有切面配置中的切入点
3. 初始化bean,  判定bean对应的类中的方法是否匹配到任意切入点
    - 匹配失败,  创建对象
    - 匹配成功,  创建原始对象(**目标对象**)的**代理**对象
4. 获取bean执行方法
   - 获取bean,  调用方法并执行,  完成操作
   - 获取的bean是代理对象时,  根据代理对象的运行模式运行原始方法与增强的内容,  完成操作

## 04-AOP切入点表达式
### AOP切入点表达式
- 切入点:要进行增强的方法
- 切入点表达式:要进行增强的方法的描述方式
- 切入点表达式标准格式:动作关键字(访问修饰符 返回值 包名.类/接口名.方法名(参数)异常名)
  - **execution(public User com.itheima.service.UserService.findById(int))**
  - 动作关键字:描述切入点的行为动作,  例如execution表示执行到指定切入点
  - 访问修饰符:public,  private等,  可以省略
  - 返回值
  - 包名
  - 类/接口名
  - 方法名
  - 参数
  - 异常名:方法定义中抛出指定异常,  可以省略

### 可以使用通配符描述切入点,  快速描述
  - *:单个独立的任意符号,  可以独立出现,  也可以作为前缀或者后缀的匹配符出现
    - execution (public * com.itheima.*.UserService.find*(*))
    - 匹配com.itheima包下的任意包中的UserService类或接口中所有find开头的带有一个参数的方法
  - 多个连续的任意符号,  可以独立出现,  常用于简化包名与参数的书写
    - execution (public User com..UserService.findById(..))
    - 匹配com包下的任意包中的UserService类或接口中所有名称为findByld的方法
  - +:专用于匹配子类类型
    - execution (* *..*Service+.*(..))

### 书写技巧
  - 所有代码按照标准规范开发, 否则以下技巧全部失效
  - 描述切入点通常描述接口, 而不描述实现类
  - 访问控制修饰符针对接口开发均采用public描述(可省略访问控制修饰符描述)
  - 返回值类型对于增删改类使用精准类型加速匹配, 对于查询类使用*通配快速描述
  - 包名书写尽量不使用..匹配, 效率过低, 常用*做单个包描述匹配, 或精准匹配
  - 接口名/类名书写名称与模块相关的采用*匹配, 例如UserService书写成*Service, 绑定业务层接口名
  - 方法名书写以动词进行精准匹配, 名词采用*匹配, 例如getByld书写成getBy', seletAl书写成selectAII
  - 参数规则较为复杂, 根据业务方法灵活调整
  - 通常不使用异常作为匹配规则

## 05R-AOP通知类型
### AOP通知类型
- AOP通知描述了抽取的共性功能, 根据共性功能抽取的位置不同, 最终运行代码时要将其加入到合理的位置
- AOP通知共分为5种类型
  - 前置通知
  - 后置通知
  - 环绕通知(重点)
  - 返回后通知(了解)
  - 抛出异常后通知(了解)

### @Around注意事项
1. 环绕通知必须依赖形参ProceedingJoinPoint才能实现对原始方法的调用, 进而实现原始方法调用前后同时添加通知
2. 通知中如果未使用ProceedingJoinPoint对原始方法进行调用将跳过原始方法的执行
3. 对原始方法的调用可以不接收返回值, 通知方法设置成void即可, 如果接收返回值, 必须设定为Object类型
4. 原始方法的返回值如果是void类型, 通知方法的返回值类型可以设置成void, 也可以设置成Object
5. 由于无法预知原始方法运行后是否会抛出异常, 因此环绕通知方法必须抛出Throwable对象

## 07-AOP通知获取数据
### AOP通知获取数据
- 获取切入点方法的参数
   - JoinPoint:适用于前置、后置、返回后、抛出异常后通知, 设置为方法的第一个形参
    - ProceedJointPoint:适用于环绕通知
- 获取切入点方法返回值
  - 返回后通知
  - 环绕通知
- 获取切入点方法运行异常信息
  - 抛出异常后通知
  - 环绕通知