# 06-事务

## TIPS
- Spring注解式事务通常添加在业务层接口中而不会添加到业务层实现类中, 降低耦合
- 注解式事务可以添加到业务方法上表示当前方法开启事务, 也可以添加到接口上表示当前接口所有方法开启事务

## 01-事务简介
### 事务简介
- 事务作用:在数据层保障一系列的数据库操作同成功同失败
- Spring事务作用:在数据层或**业务层**保障一系列的数据库操作同成功同失败

### 模拟银行账户间转账业务
- 模拟银行账户间转账业务
- 需求:实现任意两个账户间转账操作
- 需求微缩:A账户减钱, B账户加钱
- 分析:
  1. 数据层提供基础操作, 指定账户减钱(outMoney), 指定账户加钱(inMoney)
  2. 业务层提供转账操作(transfer), 调用减钱与加钱的操作
  3. 提供2个账号和操作金额执行转账操作
  4. 基于Spring整合MyBatis环境搭建上述操作
- 结果分析:
  1. 程序正常执行时, 账户金额A减B加, 没有问题
  2. 程序出现异常后, 转账失败, 但是异常之前操作成功, 异常之后操作失败, 整体业务失败

## 02-事务角色
### 事务角色
- 事务管理员:发起事务方, 在Spring中通常指代业务层开启事务的方法
- 事务协调员:加入事务方, 在Spring中通常指代数据层方法, 也可以是业务层方法

## 03-事务属性
### 事务相关配置
|属性|作用|示例|
|:--:|:--:|:--:|
|readOnly|设置是否为只读事务|readOnly=true 只读事务|
|timeout|设置事务超时时间|timeout=-1 永不超时|
|**rollbackFor**|设置事务回滚异常(class)|rollbackFor={NullPointException.class}|
|rollbackForClassName|设置事务回滚异常(String)|同上格式为字符串|
|noRollbackFor|设置事务不回滚异常(class)|noRollbackFor={NullPointException.class}|
|noRollbackForClassName|设置事务不回滚异常(String)|同上格式为字符串|
|propagation|设置事务传播行为|……|

### 案例:转账业务追加日志
- 需求:实现任意两个账户间转账操作, 并对每次转账操作在数据库进行留痕
- 需求微缩:A账户减钱, B账户加钱, 数据库记录日志
- 分析:
  1. 基于转账操作案例添加日志模块, 实现数据库中记录日志
  2. 业务层转账操作(transfer), 调用减钱、加钱与记录日志功能
- 实现效果预期:
  - 无论转账操作是否成功, 均进行转账操作的日志留痕
- 存在的问题:
  - 日志的记录与转账操作隶属同一个事务, 同成功同失败
- 实现效果预期改进:
  - 无论转账操作是否成功, 日志必须保留

### 事务传播行为
![事务传播行为](../static/img/06-%E4%BA%8B%E5%8A%A1/03-%E4%BA%8B%E5%8A%A1%E5%B1%9E%E6%80%A7/swcbxw.png)